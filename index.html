<!doctype html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>TeacherList ë‹¨ê±´ ì¶”ê°€ (Firestore)</title>
    <style>
        :root {
            --gap: 10px;
        }

        body {
            font-family: Pretendard, system-ui, Apple SD Gothic Neo, sans-serif;
            margin: 0;
            background: #f7f7fb;
            color: #111
        }

        header {
            background: #1e293b;
            color: #fff;
            padding: 14px 18px
        }

        main {
            max-width: 980px;
            margin: 20px auto;
            background: #fff;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 18px
        }

        h1 {
            margin: 0;
            font-size: 18px
        }

        h2 {
            margin: 18px 0 10px;
            font-size: 16px
        }

        .grid {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 10px var(--gap);
            align-items: center
        }

        label {
            color: #6b7280
        }

        input,
        textarea,
        button {
            font: inherit
        }

        input,
        textarea {
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 10px;
            width: 100%
        }

        textarea {
            min-height: 72px;
            resize: vertical
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center
        }

        .hint {
            color: #6b7280;
            font-size: 13px
        }

        .btns {
            display: flex;
            gap: 8px;
            margin-top: 14px
        }

        button {
            border: 1px solid #cbd5e1;
            background: #fff;
            border-radius: 10px;
            padding: 10px 14px;
            cursor: pointer
        }

        button:hover {
            background: #f3f4f6
        }

        .ok {
            color: #059669
        }

        .warn {
            color: #b45309
        }

        .mono {
            font-family: ui-monospace, SFMono-Regular, Menlo, monospace
        }

        .card {
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 12px;
            margin-top: 16px
        }

        .kv {
            display: grid;
            grid-template-columns: 140px 1fr;
            gap: 6px var(--gap);
            font-size: 14px
        }

        .kv div:nth-child(odd) {
            color: #6b7280
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            font-size: 14px
        }

        th,
        td {
            border-top: 1px solid #e5e7eb;
            padding: 8px 6px;
            text-align: left;
        }

        th {
            background: #f9fafb;
            color: #374151
        }

        .tools {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .section {
            border-top: 1px dashed #e5e7eb;
            margin-top: 18px;
            padding-top: 18px;
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ‘¨â€ğŸ« TeacherList ë‹¨ê±´ ì¶”ê°€</h1>
    </header>

    <main>
        <p class="hint">
            â€¢ <strong>ì¢Œì„</strong>ì„ ì…ë ¥í•˜ë©´ ë¬¸ì„œ IDëŠ” <span class="mono">êµë¬´ì‹¤|í–‰-ì—´</span>ë¡œ ì €ì¥ë©ë‹ˆë‹¤. (ì˜ˆ: <span
                class="mono">êµë¬´ê¸°íšë¶€|1-1</span>)<br>
            â€¢ ì¢Œì„ì„ ë¹„ì›Œë‘ë©´ ì„ì‹œë¡œ <strong>ì´ë¦„ 2ê¸€ì</strong>(ì˜ˆ: <span class="mono">ì†ë‘</span>)ë¥¼ IDë¡œ ì €ì¥í•©ë‹ˆë‹¤.<br>
            â€¢ <strong>fetchedSubjects</strong>ëŠ” ì½¤ë§ˆ(,)ë¡œ êµ¬ë¶„í•´ ì…ë ¥í•˜ë©´ ë°°ì—´ë¡œ ì €ì¥ë©ë‹ˆë‹¤.
        </p>

        <!-- ===== ì €ì¥ í¼ ===== -->
        <section class="grid" style="margin-top:14px">
            <label>ì „ì²´ ì´ë¦„</label>
            <div class="row">
                <input id="fullName" placeholder="ì˜ˆ: ì†ë‘í˜„ (ì…ë ¥ ì‹œ ì•„ë˜ ìë™ ë¶„í•´)" />
                <button id="btnSplit">ë¶„í•´</button>
            </div>

            <label>ì´ë¦„ 2ê¸€ì</label>
            <input id="two" placeholder="ì˜ˆ: ì†ë‘" />

            <label>ë ê¸€ì</label>
            <input id="last" placeholder="ì˜ˆ: í˜„ (ì„ íƒ)" />

            <label>êµë¬´ì‹¤(ë¶€ì„œ)</label>
            <input id="dept" placeholder="ì˜ˆ: êµë¬´ê¸°íšë¶€" />

            <label>ì¢Œì„(í–‰-ì—´)</label>
            <input id="seat" placeholder="ì˜ˆ: 1-1 (ì„ íƒ)" />

            <label>êµê³¼</label>
            <input id="subject" placeholder="ì˜ˆ: êµ­ì–´" />

            <label>ë‚´ì„ </label>
            <input id="ext" placeholder="ì˜ˆ: 373" />

            <label>ë©”ëª¨</label>
            <textarea id="memo" placeholder="ë¹„ê³ /ì„¸ë¶€ ì—­í•  ë“±"></textarea>

            <label>fetchedSubjects</label>
            <input id="fetched" placeholder="ì˜ˆ: ë¬¸í•™, í™”ë²•ê³¼ì‘ë¬¸ (ì„ íƒ)" />
        </section>

        <div class="btns">
            <button id="btnSave">ì €ì¥</button>
            <button id="btnClear">ì´ˆê¸°í™”</button>
        </div>

        <div id="status" class="hint" style="margin-top:10px">ëŒ€ê¸° ì¤‘â€¦</div>

        <div id="preview" class="card" hidden>
            <strong>ë¯¸ë¦¬ë³´ê¸°</strong>
            <div class="kv" id="kv"></div>
        </div>

        <!-- ===== ê²€ìƒ‰/ì‚­ì œ ì„¹ì…˜ ===== -->
        <section class="section">
            <h2>ğŸ” ê²€ìƒ‰ & ğŸ—‘ ì‚­ì œ</h2>
            <p class="hint">í•„ìš”í•œ ì¡°ê±´ì„ í•˜ë‚˜ ì´ìƒ ì…ë ¥í•˜ê³  â€œê²€ìƒ‰â€ì„ ëˆ„ë¥´ì„¸ìš”. ê²°ê³¼ì—ì„œ ê°œë³„ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤. (two ê°’ì€ ì¤‘ë³µ ê°€ëŠ¥!)</p>

            <div class="grid" style="margin-top:8px">
                <label>ì´ë¦„ 2ê¸€ì(two)</label>
                <input id="qTwo" placeholder="ì˜ˆ: ì†ë‘" />

                <label>êµë¬´ì‹¤(ë¶€ì„œ)</label>
                <input id="qDept" placeholder="ì˜ˆ: êµë¬´ê¸°íšë¶€" />

                <label>ì¢Œì„(í–‰-ì—´)</label>
                <input id="qSeat" placeholder="ì˜ˆ: 1-1" />

                <label>êµê³¼</label>
                <input id="qSubject" placeholder="ì˜ˆ: êµ­ì–´" />
            </div>

            <div class="btns">
                <button id="btnSearch">ê²€ìƒ‰</button>
                <button id="btnSearchClear">ê²€ìƒ‰ ì…ë ¥ ì´ˆê¸°í™”</button>
            </div>

            <div id="searchStatus" class="hint" style="margin-top:8px">ê²€ìƒ‰ ëŒ€ê¸° ì¤‘â€¦</div>

            <div id="searchArea" class="card" hidden>
                <strong>ê²€ìƒ‰ ê²°ê³¼</strong>
                <div class="tools" style="margin-top:8px">
                    <input id="deleteId" placeholder="ë¬¸ì„œ IDë¡œ ë°”ë¡œ ì‚­ì œ (ì˜ˆ: êµë¬´ê¸°íšë¶€|1-1 ë˜ëŠ” ì†ë‘)" style="flex:1 1 320px">
                    <button id="btnDeleteById">IDë¡œ ì‚­ì œ</button>
                </div>

                <table id="resultTable">
                    <thead>
                        <tr>
                            <th>ë¬¸ì„œID</th>
                            <th>í‘œì‹œì´ë¦„</th>
                            <th>ë¶€ì„œ</th>
                            <th>ì¢Œì„</th>
                            <th>êµê³¼</th>
                            <th>ë‚´ì„ </th>
                            <th>ì‘ì—…</th>
                        </tr>
                    </thead>
                    <tbody id="resultBody"></tbody>
                </table>
            </div>
        </section>
    </main>

    <script type="module">
        /* ================= Firebase ================= */
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import {
            getFirestore, doc, setDoc,
            collection, getDocs, query, where, limit,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // ğŸ”§ ë„¤ í”„ë¡œì íŠ¸ ê°’ ì‚¬ìš©
        const firebaseConfig = {
            apiKey: "AIzaSyAKXEXX-c_hbMIUYjPYcxxtQXdNG43yLPw",
            authDomain: "helloworld-d52fc.firebaseapp.com",
            databaseURL: "https://helloworld-d52fc-default-rtdb.firebaseio.com",
            projectId: "helloworld-d52fc",
            storageBucket: "helloworld-d52fc.firebasestorage.app",
            messagingSenderId: "78372272607",
            appId: "1:78372272607:web:101fa71bf152d6bc452c6a",
            measurementId: "G-X0ZBR60N2C"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        /* ================= Helpers ================= */
        const $ = (id) => document.getElementById(id);
        const status = (msg, cls = '') => { const el = $('status'); el.textContent = msg; el.className = 'hint ' + cls; };
        const sStatus = (msg, cls = '') => { const el = $('searchStatus'); el.textContent = msg; el.className = 'hint ' + cls; };
        const seatDocId = (dept, seat) => `${dept}|${seat}`.trim();

        function splitTwoLast(name) {
            const s = (name || '').trim();
            if (!s) return { two: '', last: '' };
            const two = s.slice(0, 2);
            const last = s.slice(2);
            return { two, last };
        }

        function toArray(csv) {
            if (!csv) return [];
            return csv.split(',').map(s => s.trim()).filter(Boolean);
        }

        function preview(data) {
            const box = $('preview'); const kv = $('kv');
            kv.innerHTML = '';
            const rows = [
                ['ë¬¸ì„œ ID', data.__id || '(ì €ì¥ ì‹œ ê²°ì •)'],
                ['ì´ë¦„(í‘œì‹œ)', (data.two || '') + (data.last || '')],
                ['ì´ë¦„ 2ê¸€ì', data.two || ''],
                ['ë ê¸€ì', data.last || ''],
                ['êµë¬´ì‹¤', data.dept || ''],
                ['ì¢Œì„', data.seat || ''],
                ['êµê³¼', data.subject || ''],
                ['ë‚´ì„ ', data.ext || ''],
                ['ë©”ëª¨', data.memo || ''],
                ['fetchedSubjects', (data.fetchedSubjects || []).join(' | ')]
            ];
            for (const [k, v] of rows) {
                const kdiv = document.createElement('div'); kdiv.textContent = k;
                const vdiv = document.createElement('div'); vdiv.textContent = String(v || '');
                kv.append(kdiv, vdiv);
            }
            box.hidden = false;
        }

        function readForm() {
            const two = $('two').value.trim();
            const last = $('last').value.trim();
            const dept = $('dept').value.trim();
            const seat = $('seat').value.trim();      // ex) 1-1
            const subject = $('subject').value.trim();
            const ext = $('ext').value.trim();
            const memo = $('memo').value.trim();
            const fetchedSubjects = toArray($('fetched').value.trim());
            return { two, last, dept, seat, subject, ext, memo, fetchedSubjects };
        }

        function validate(data) {
            if (!data.two) return 'ì´ë¦„ 2ê¸€ìë¥¼ ì…ë ¥í•˜ì„¸ìš”.';
            if (data.seat && !/^\d+\-\d+$/.test(data.seat)) return 'ì¢Œì„ì€ "í–‰-ì—´" í˜•ì‹ìœ¼ë¡œ ì…ë ¥í•˜ì„¸ìš”. (ì˜ˆ: 1-1)';
            return null;
        }

        function clearForm() {
            ['fullName', 'two', 'last', 'dept', 'seat', 'subject', 'ext', 'memo', 'fetched'].forEach(id => { $(id).value = ''; });
            $('preview').hidden = true;
            status('ì´ˆê¸°í™” ì™„ë£Œ');
        }

        /* ================= Save UI ================= */
        $('btnSplit').addEventListener('click', () => {
            const { two, last } = splitTwoLast($('fullName').value);
            $('two').value = two; $('last').value = last;
        });

        $('btnSave').addEventListener('click', async () => {
            const data = readForm();
            const msg = validate(data);
            if (msg) { status(msg, 'warn'); return; }

            // ë¬¸ì„œ ID ê²°ì •
            let docId = '';
            if (data.dept && data.seat) {
                docId = seatDocId(data.dept, data.seat);  // ex) êµë¬´ê¸°íšë¶€|1-1
            } else {
                docId = data.two || 'unknown';            // ì¢Œì„ ë¯¸ì§€ì • ì‹œ ì„ì‹œ í‚¤
            }
            data.updatedAt = Date.now();

            try {
                await setDoc(doc(db, 'teacher_list', docId), data, { merge: true });
                data.__id = docId;
                preview(data);
                status('ì €ì¥ë¨: ' + docId, 'ok');
            } catch (err) {
                console.error(err);
                status('ì €ì¥ ì‹¤íŒ¨: ' + (err?.message || err), 'warn');
            }
        });

        $('btnClear').addEventListener('click', clearForm);

        /* ================= Search & Delete ================= */
        function readSearch() {
            return {
                two: $('qTwo').value.trim(),
                dept: $('qDept').value.trim(),
                seat: $('qSeat').value.trim(),
                subject: $('qSubject').value.trim(),
            };
        }

        function renderResults(items) {
            const area = $('searchArea');
            const tbody = $('resultBody');
            tbody.innerHTML = '';

            for (const it of items) {
                const tr = document.createElement('tr');

                const idTd = document.createElement('td'); idTd.textContent = it.id;
                const nameTd = document.createElement('td'); nameTd.textContent = (it.two || '') + (it.last || '');
                const deptTd = document.createElement('td'); deptTd.textContent = it.dept || '';
                const seatTd = document.createElement('td'); seatTd.textContent = it.seat || '';
                const subjTd = document.createElement('td'); subjTd.textContent = it.subject || '';
                const extTd = document.createElement('td'); extTd.textContent = it.ext || '';

                const actTd = document.createElement('td');
                const delBtn = document.createElement('button');
                delBtn.textContent = 'ì‚­ì œ';
                delBtn.addEventListener('click', async () => {
                    const ok = confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”?\n\në¬¸ì„œID: ${it.id}\nì´ë¦„: ${(it.two || '') + (it.last || '')}\në¶€ì„œ/ì¢Œì„: ${(it.dept || '-')}/${(it.seat || '-')}`);
                    if (!ok) return;
                    try {
                        await deleteDoc(doc(db, 'teacher_list', it.id));
                        sStatus(`ì‚­ì œë¨: ${it.id}`, 'ok');
                        // í™”ë©´ì—ì„œ ì œê±°
                        tr.remove();
                        if (!tbody.children.length) $('searchArea').hidden = true;
                    } catch (err) {
                        console.error(err);
                        sStatus('ì‚­ì œ ì‹¤íŒ¨: ' + (err?.message || err), 'warn');
                    }
                });
                actTd.appendChild(delBtn);

                tr.append(idTd, nameTd, deptTd, seatTd, subjTd, extTd, actTd);
                tbody.appendChild(tr);
            }
            area.hidden = items.length === 0;
        }

        async function searchTeachers() {
            const { two, dept, seat, subject } = readSearch();

            // ì¡°ê±´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ê²½ê³ 
            if (!two && !dept && !seat && !subject) {
                sStatus('ìµœì†Œ í•˜ë‚˜ì˜ ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ì„¸ìš”.', 'warn');
                $('searchArea').hidden = true;
                return;
            }

            try {
                sStatus('ê²€ìƒ‰ ì¤‘â€¦');
                const cRef = collection(db, 'teacher_list');
                const conds = [];
                if (two) conds.push(where('two', '==', two));
                if (dept) conds.push(where('dept', '==', dept));
                if (seat) conds.push(where('seat', '==', seat));
                if (subject) conds.push(where('subject', '==', subject));

                // FirestoreëŠ” ë³µí•© where ì‹œ ì¸ë±ìŠ¤ê°€ í•„ìš”í•  ìˆ˜ë„ ìˆì–´ìš”.
                // ì¸ë±ìŠ¤ ìš”ì²­ ì—ëŸ¬ê°€ ë‚˜ë©´ ì½˜ì†” ë§í¬ ëˆŒëŸ¬ ì¸ë±ìŠ¤ ìƒì„±í•´ ì£¼ì„¸ìš”.
                const qRef = conds.length ? query(cRef, ...conds, limit(50)) : query(cRef, limit(50));
                const snap = await getDocs(qRef);

                const list = [];
                snap.forEach(d => list.push({ id: d.id, ...d.data() }));
                if (list.length === 0) {
                    sStatus('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
                    $('searchArea').hidden = true;
                    return;
                }
                sStatus(`ê²€ìƒ‰ ê²°ê³¼ ${list.length}ê±´`, 'ok');
                renderResults(list);
            } catch (err) {
                console.error(err);
                sStatus('ê²€ìƒ‰ ì‹¤íŒ¨: ' + (err?.message || err), 'warn');
                $('searchArea').hidden = true;
            }
        }

        $('btnSearch').addEventListener('click', searchTeachers);
        $('btnSearchClear').addEventListener('click', () => {
            ['qTwo', 'qDept', 'qSeat', 'qSubject'].forEach(id => { $(id).value = ''; });
            $('searchArea').hidden = true;
            sStatus('ê²€ìƒ‰ ì…ë ¥ì„ ë¹„ì› ìŠµë‹ˆë‹¤.');
        });

        $('btnDeleteById').addEventListener('click', async () => {
            const id = $('deleteId').value.trim();
            if (!id) { sStatus('ë¬¸ì„œ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.', 'warn'); return; }
            const ok = confirm(`ì •ë§ ì‚­ì œí• ê¹Œìš”?\në¬¸ì„œID: ${id}`);
            if (!ok) return;
            try {
                await deleteDoc(doc(db, 'teacher_list', id));
                sStatus(`ì‚­ì œë¨: ${id}`, 'ok');
                // ê²°ê³¼ í…Œì´ë¸”ì—ë„ ë°˜ì˜(ìˆë‹¤ë©´ ì œê±°)
                const rows = Array.from($('resultBody').children);
                for (const tr of rows) {
                    if (tr.firstChild?.textContent === id) tr.remove();
                }
                if (!$('resultBody').children.length) $('searchArea').hidden = true;
            } catch (err) {
                console.error(err);
                sStatus('ì‚­ì œ ì‹¤íŒ¨: ' + (err?.message || err), 'warn');
            }
        });
    </script>
</body>

</html>
